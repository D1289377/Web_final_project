<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ¨‚äº‹ç‰©åƒ¹æŸ¥è©¢</title>
  <style>
    body {
      background: #fffad1;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      text-align: center;
      font-size: 3em;
      color: #d62828;
      margin: 30px 0 10px;
      letter-spacing: 0.1em;
    }

    .main-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px 20px;
      gap: 20px;
      width: 100%;
    }

    form#insertForm {
      background: #fff;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    form#insertForm label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      color: #333;
    }

    form#insertForm input {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }

    form#insertForm button {
      width: 100%;
      padding: 10px;
      background-color: #d62828;
      color: white;
      font-size: 1.1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    form#insertForm button:hover {
      background-color: #b91c1c;
    }

    #resultMsg {
      text-align: center;
      font-size: 1em;
      color: #007f00;
      margin-top: 8px;
    }

    .search-section {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .search-section input, .search-section button {
      font-size: 1em;
      padding: 8px 12px;
      border: 1px solid #bbb;
      border-radius: 6px;
    }

    .search-section button {
      background-color: #f77f00;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .search-section button:hover {
      background-color: #d97700;
    }

    #priceTable {
      width: 100%;
      max-width: 600px;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    #priceTable th, #priceTable td {
      border: 1px solid #eee;
      padding: 12px;
      text-align: center;
      font-size: 1em;
    }

    #priceTable th {
      background-color: #ffe600;
      color: #000;
    }

    #priceTable td {
      background-color: #fff;
    }

    .product-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
    }

    .product-btn {
      padding: 8px 12px;
      font-size: 1em;
      border: 1px solid #bbb;
      border-radius: 6px;
      cursor: pointer;
      background-color: #f77f00;
      color: white;
      transition: background-color 0.3s;
    }

    .product-btn:hover {
      background-color: #d97700;
    }

    #exportBtn, #importBtn {
      background: #b7e4c7;
      color: #333;
      border: none; /* å»æ‰é»‘è‰²æ¡†ç·š */
      border-radius: 10px; /* åœ“è§’ */
      font-size: 1.15em; /* æ”¾å¤§å­—é«” */
      padding: 12px 28px; /* æ”¾å¤§æŒ‰éˆ• */
      cursor: pointer;
      transition: background 0.2s;
      font-weight: bold;
    }

    #exportBtn:hover, #importBtn:hover {
      background: #d8f3dc;
    }

    #importBtn {
      background: #a5d8ff;
    }

    #importBtn:hover {
      background: #d0ebff;
    }

    .product-images {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .product-img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .product-img:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

  </style>
</head>

<body>
<h1>æ¨‚äº‹ç‰©åƒ¹æŸ¥è©¢</h1>
<div class="main-container">
  <div class="product-images">
    <img src="/lays_all.jpg" class="product-img" data-name="" alt="å…¨éƒ¨">
    <img src="/lays_original.png" class="product-img" data-name="åŸå‘³" alt="åŸå‘³">
    <img src="/lays_seaweed.png" class="product-img" data-name="æµ·è‹”" alt="æµ·è‹”">
    <img src="/lays_spicy.png" class="product-img" data-name="è¾£å‘³" alt="è¾£å‘³">
    <img src="/lays_cheese.png" class="product-img" data-name="èµ·å¸" alt="èµ·å¸">
    <img src="/lays_salt.png" class="product-img" data-name="é¹½å‘³" alt="é¹½å‘³">
    <img src="/lays_BBQ.png" class="product-img" data-name="çƒ¤è‚‰" alt="çƒ¤è‚‰">
  </div>

  <!-- åŒ¯å…¥/åŒ¯å‡ºå€å¡Š -->
  <div style="display:flex;gap:10px;align-items:center;margin:10px 0;">
    <button id="exportBtn" type="button">åŒ¯å‡ºCSV</button>
    <input type="file" id="importFile" accept=".csv" style="display:none;">
    <button id="importBtn" type="button">åŒ¯å…¥CSV</button>
    <span id="importMsg" style="color:#d62828;font-size:0.95em;"></span>
  </div>
  <!-- åƒ¹æ ¼é€šçŸ¥è¨­å®šå€å¡Š -->
  <div id="notifySection"
       style="background:#fff3cd;padding:16px 20px;border-radius:10px;box-shadow:0 2px 8px #0001;max-width:400px;width:100%;margin-bottom:10px;">
    <b>åƒ¹æ ¼é€šçŸ¥è¨­å®š</b><br>
    <label>
      å•†å“åç¨±ï¼š
      <input type="text" id="notifyName" style="width:120px;">
    </label>
    <label>
      <select id="notifyType">
        <option value="below">ä½æ–¼</option>
        <option value="above">é«˜æ–¼</option>
      </select>
    </label>
    <input type="number" id="notifyPrice" style="width:80px;" placeholder="åƒ¹æ ¼">
    <button id="setNotifyBtn" type="button" style="margin-left:8px;">è¨­å®š</button>
    <span id="notifyMsg" style="color:#d62828;font-size:0.95em;margin-left:8px;"></span>
  </div>
  <!-- è¨‚é–± Email è¼¸å…¥å€å¡Š -->
  <div id="subscribeSection"
       style="background:#e3f2fd;padding:16px 20px;border-radius:10px;box-shadow:0 2px 8px #0001;max-width:400px;width:100%;margin-bottom:10px;">
    <b>è¨‚é–±åƒ¹æ ¼é€šçŸ¥ Email</b><br>
    <input type="email" id="subscribeEmail" placeholder="è«‹è¼¸å…¥ Email" style="width:200px;padding:6px;">
    <button id="subscribeBtn" type="button" style="margin-left:10px;">è¨‚é–±</button>
    <span id="subscribeMsg" style="color:#007f00;font-size:0.95em;margin-left:10px;"></span>
  </div>
  <!-- è¡¨å–® -->
  <form id="insertForm">
    <label for="date">æ—¥æœŸï¼š</label>
    <input type="date" id="date" name="date" required>

    <label for="product_name">å•†å“åç¨±ï¼š</label>
    <input type="text" id="product_name" name="product_name" required>

    <label for="product_price">å•†å“åƒ¹æ ¼ï¼š</label>
    <input type="number" id="product_price" name="product_price" required>

    <button type="submit">æ–°å¢</button>
    <p id="resultMsg"></p>
  </form>

  <!-- æœå°‹ -->
  <div class="search-section">
    <input type="date" id="startDate" placeholder="é–‹å§‹æ—¥æœŸ">
    <input type="date" id="endDate" placeholder="çµæŸæ—¥æœŸ">
    <input type="text" id="searchInput" placeholder="è¼¸å…¥å•†å“é—œéµå­—">
    <button id="searchBtn">æœå°‹</button>
  </div>

  <!-- çµ±è¨ˆåˆ†æå€å¡Š -->
  <div id="statInfo" style="font-size:1.1em;color:#333;margin:18px 0 8px 0;"></div>

  <!-- æ­·å²åƒ¹æ ¼å€å¡Š -->
  <div id="historyPriceInfo" style="font-size:1.1em;color:#333;"></div>

  <!-- è¡¨æ ¼ -->
  <table id="priceTable">
    <thead>
    <tr>
      <th>æ—¥æœŸ</th>
      <th>å•†å“åç¨±</th>
      <th>å•†å“åƒ¹æ ¼</th>
      <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
  <!-- æŠ˜ç·šåœ–å®¹å™¨ -->
  <canvas id="lineChart" width="600" height="300" style="margin-top:30px;"></canvas>
  <div id="forecastInfo" style="font-size:1.1em; color:#1d3557; margin-top:10px;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // åƒ¹æ ¼é€šçŸ¥åŠŸèƒ½
  let notifySetting = null; // {name, type, price}
  let notifiedIds = new Set(); // é¿å…é‡è¤‡é€šçŸ¥

  // è¨­å®šé€šçŸ¥
  document.getElementById('setNotifyBtn').addEventListener('click', function () {
    const name = document.getElementById('notifyName').value.trim();
    const type = document.getElementById('notifyType').value;
    const price = Number(document.getElementById('notifyPrice').value);
    const msg = document.getElementById('notifyMsg');
    if (!name || !price) {
      msg.textContent = 'è«‹è¼¸å…¥å•†å“åç¨±èˆ‡åƒ¹æ ¼';
      return;
    }
    notifySetting = {name, type, price};
    notifiedIds.clear();
    msg.style.color = '#007f00';
    msg.textContent = `å·²è¨­å®šï¼š${name} åƒ¹æ ¼${type === 'below' ? 'ä½æ–¼' : 'é«˜æ–¼'} ${price} æ™‚é€šçŸ¥`;
  });

  // æª¢æŸ¥æ˜¯å¦æœ‰ç¬¦åˆé€šçŸ¥æ¢ä»¶çš„è³‡æ–™
  function checkNotify(data) {
    if (!notifySetting) return;
    let found = false;
    data.forEach(row => {
      if (
              row.product_name === notifySetting.name &&
              (
                      (notifySetting.type === 'below' && Number(row.product_price) < notifySetting.price) ||
                      (notifySetting.type === 'above' && Number(row.product_price) > notifySetting.price)
              ) &&
              !notifiedIds.has(row.id)
      ) {
        found = true;
        notifiedIds.add(row.id);
        // å½ˆçª—é€šçŸ¥
        alert(`ã€åƒ¹æ ¼é€šçŸ¥ã€‘\n${row.product_name} åƒ¹æ ¼${notifySetting.type === 'below' ? 'ä½æ–¼' : 'é«˜æ–¼'} ${notifySetting.price}ï¼\næ—¥æœŸï¼š${row.date}\nåƒ¹æ ¼ï¼š${row.product_price}`);
      }
    });
  }

  // åœ¨æ¯æ¬¡è¼‰å…¥è¡¨æ ¼æ™‚è‡ªå‹•æª¢æŸ¥
  const oldLoadPriceTable = loadPriceTable;
  loadPriceTable = function (data, keyword = '') {
    oldLoadPriceTable(data, keyword);
    checkNotify(data);
  };

  async function loadPriceTable(data, keyword = '') {
    const tbody = document.querySelector('#priceTable tbody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">æŸ¥ç„¡è³‡æ–™</td></tr>';
      document.getElementById('statInfo').innerHTML = '';
      drawLineChart([]); // æ¸…ç©ºåœ–è¡¨
      return;
    }

    // æ—¥æœŸæ’åº
    data.sort((a, b) => b.date.localeCompare(a.date));
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.date}</td><td>${row.product_name}</td><td>${row.product_price}</td><td><button class="delete-btn" data-id="${row.id}">åˆªé™¤</button></td>`;
      tbody.appendChild(tr);
    });

    // æ­·å²åƒ¹æ ¼è³‡è¨Šï¼ˆåªæœ‰æœ‰é—œéµå­—æ™‚æ‰é¡¯ç¤ºï¼‰
    if (keyword !== '') {
      showHistoryPriceInfo(data);
    } else {
      document.getElementById('historyPriceInfo').textContent = '';
    }

    // çµ±è¨ˆåˆ†æ
    showStatInfo(data);

    // âœ… é—œéµæ”¹é€™è£¡ï¼šä½¿ç”¨åƒæ•¸ keyword åˆ¤æ–·
    if (keyword === '') {
      drawMultiLineChart(data); // å…¨å•†å“
      document.getElementById('forecastInfo').textContent = '';
    } else {
      drawLineChart(data, keyword); // å–®å•†å“
    }

    checkNotify(data);
  }



  async function fetchAll() {
    try {
      console.log('[fetchAll] called');
      const res = await fetch('/api/price');
      const data = await res.json();
      console.log('[fetchAll] data =', data);
      loadPriceTable(data, '');  // âœ… åŠ ä¸Šç©ºå­—ä¸² keyword
    } catch (err) {
      loadPriceTable([], '');    // âœ… åŠ ä¸Šç©ºå­—ä¸² keyword
    }
  }


  async function searchPrice(keyword, startDate, endDate) {
    const params = new URLSearchParams();
    if (keyword) params.append('name', keyword);
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    try {
      const res = await fetch(`/api/price/search?${params.toString()}`);
      const data = await res.json();
      loadPriceTable(data, keyword); // ğŸ‘ˆ å‚³å…¥ keyword
    } catch (err) {
      loadPriceTable([], keyword);
    }
  }


  // Chart.js æŠ˜ç·šåœ–ç¹ªè£½å‡½å¼
  let chartInstance = null;
  function drawLineChart(data) {
    const ctx = document.getElementById('lineChart').getContext('2d');

    if (chartInstance) chartInstance.destroy();

    if (!data || data.length === 0) {
      ctx.clearRect(0, 0, 600, 300);
      document.getElementById('forecastInfo').textContent = '';
      return;
    }

    // å–ç›®å‰è³‡æ–™çš„å•†å“åç¨±ï¼ˆå‰ææ˜¯åªæŸ¥è©¢å–®ä¸€å•†å“ï¼‰
    const targetName = data[0].product_name;
    const filtered = data.filter(row => row.product_name === targetName);

    console.log('[é æ¸¬æª¢æŸ¥] filtered =', filtered);
    console.log('[é æ¸¬æª¢æŸ¥] ç­†æ•¸ =', filtered.length);

    // å¦‚æœè©²å•†å“åªæœ‰ 1 ç­†ï¼Œæ²’è¾¦æ³•é æ¸¬ï¼Œä½†é‚„æ˜¯ç•«é»åœ–
    if (filtered.length === 0) {
      ctx.clearRect(0, 0, 600, 300);
      return;
    }

    filtered.sort((a, b) => a.date.localeCompare(b.date));
    const labels = filtered.map(row => row.date);
    const prices = filtered.map(row => Number(row.product_price));

    // æ‰¾æœ€å¤§æœ€å°åƒ¹æ ¼é»
    let minIdx = 0, maxIdx = 0;
    prices.forEach((p, i) => {
      if (p < prices[minIdx]) minIdx = i;
      if (p > prices[maxIdx]) maxIdx = i;
    });

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: `${targetName} åƒ¹æ ¼è®ŠåŒ–`,
          data: prices,
          borderColor: 'rgba(255,99,132,1)',
          backgroundColor: 'rgba(255,99,132,0.2)',
          fill: false,
          tension: 0.1,
          pointBackgroundColor: prices.map((p, i) =>
                  i === minIdx ? '#007f00' : i === maxIdx ? '#d62828' : 'rgba(255,99,132,1)'
          ),
          pointRadius: prices.map((p, i) =>
                  (i === minIdx || i === maxIdx) ? 7 : 4
          ),
        }]
      },
      options: {
        responsive: false,
        plugins: {
          legend: { display: true },
          title: {
            display: true,
            text: `${targetName} åƒ¹æ ¼è®ŠåŒ–åœ–`,
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                label += context.parsed.y;
                if (context.dataIndex === minIdx) label += 'ï¼ˆæœ€ä½åƒ¹ï¼‰';
                if (context.dataIndex === maxIdx) label += 'ï¼ˆæœ€é«˜åƒ¹ï¼‰';
                return label;
              }
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'æ—¥æœŸ' } },
          y: { title: { display: true, text: 'åƒ¹æ ¼' }, beginAtZero: true, suggestedMin: 0 }
        }
      }
    });

    // ğŸ”® é æ¸¬åƒ¹æ ¼ï¼ˆéœ€è¦è‡³å°‘å…©ç­†è³‡æ–™ï¼‰
    if (filtered.length >= 2) {
      const x = filtered.map((_, i) => i);
      const y = filtered.map(row => Number(row.product_price));

      const n = x.length;
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = y.reduce((a, b) => a + b, 0);
      const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
      const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);

      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;

      const nextX = x.length;
      const nextPrice = (slope * nextX + intercept).toFixed(2);

      console.log('[é æ¸¬é€²å…¥] ç­†æ•¸ =', filtered.length); // âœ… æ–°å¢é€™è¡Œ
      console.log('[é æ¸¬è³‡æ–™]', prices);
      console.log('[é æ¸¬çµæœ] slope =', slope, 'intercept =', intercept, 'nextPrice =', nextPrice);

      document.getElementById('forecastInfo').innerHTML =
              `ğŸ“ˆ <b>${targetName}</b> é æ¸¬ä¸‹æ¬¡åƒ¹æ ¼ï¼š<span style="color:#e76f51;font-weight:bold">${nextPrice}</span>`;
    } else {
      document.getElementById('forecastInfo').textContent = '';
    }
  }


  function drawMultiLineChart(data) {
    const ctx = document.getElementById('lineChart').getContext('2d');
    if (chartInstance) {
      chartInstance.destroy();
    }

    // ä¾å•†å“åç¨±åˆ†çµ„
    const group = {};
    data.forEach(row => {
      if (!group[row.product_name]) group[row.product_name] = [];
      group[row.product_name].push(row);
    });

    // å–å¾—æ‰€æœ‰æ—¥æœŸï¼ˆå»é‡æ’åºï¼‰
    const allDates = Array.from(new Set(data.map(row => row.date))).sort();

    // é¡è‰²è¡¨
    const colorList = [
      'rgba(214,40,40,1)',   // ç´…
      'rgba(33,158,188,1)',  // è—
      'rgba(255,183,3,1)',   // é»ƒ
      'rgba(0,168,107,1)',   // ç¶ 
      'rgba(131,56,236,1)',  // ç´«
      'rgba(255,87,51,1)',   // æ©˜
    ];

    // æ¯å€‹å•†å“ä¸€æ¢ç·š
    const datasets = Object.keys(group).map((name, idx) => {
      // ä¾æ—¥æœŸæ’åº
      const arr = group[name].slice().sort((a, b) => a.date.localeCompare(b.date));
      // ä»¥ allDates ç‚º x è»¸ï¼Œæ²’æœ‰è³‡æ–™çš„æ—¥æœŸè£œ null
      const priceMap = {};
      arr.forEach(row => {
        priceMap[row.date] = Number(row.product_price);
      });
      const prices = allDates.map(date => priceMap[date] ?? null);
      return {
        label: name,
        data: prices,
        borderColor: colorList[idx % colorList.length],
        backgroundColor: colorList[idx % colorList.length] + '33', // é€æ˜
        fill: false,
        tension: 0.1,
        spanGaps: true,
        pointRadius: 4,
      };

    });

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: allDates,
        datasets: datasets
      },
      options: {
        responsive: false,
        plugins: {
          legend: { display: true },
          title: {
            display: true,
            text: 'å„å•†å“åƒ¹æ ¼è®ŠåŒ–åœ–',
            font: { size: 16 }
          }
        },
        scales: {
          x: {title: {display: true, text: 'æ—¥æœŸ'}},
          y: { title: { display: true, text: 'åƒ¹æ ¼' }, beginAtZero: true, suggestedMin: 0 }
        }
      }
    });
  }

  // é¡¯ç¤ºæ­·å²æœ€ä½/æœ€é«˜åƒ¹è³‡è¨Š
  function showHistoryPriceInfo(data) {
    if (!data || data.length === 0) {
      document.getElementById('historyPriceInfo').textContent = '';
      return;
    }
    // åªé‡å°ç›®å‰æŸ¥è©¢çµæœçš„å•†å“ï¼ˆå¦‚æœ‰å¤šç¨®å•†å“ï¼Œåƒ…é¡¯ç¤ºæŸ¥è©¢çµæœçš„å…¨éƒ¨ï¼‰
    let min = data[0], max = data[0];
    data.forEach(row => {
      if (Number(row.product_price) < Number(min.product_price)) min = row;
      if (Number(row.product_price) > Number(max.product_price)) max = row;
    });
    document.getElementById('historyPriceInfo').innerHTML =
      `æ­·å²æœ€ä½åƒ¹ï¼š<b style="color:#007f00">${min.product_price}</b>ï¼ˆ${min.date}ï¼‰ã€€` +
      `æ­·å²æœ€é«˜åƒ¹ï¼š<b style="color:#d62828">${max.product_price}</b>ï¼ˆ${max.date}ï¼‰`;
  }

  // çµ±è¨ˆåˆ†æé¡¯ç¤º
  function showStatInfo(data) {
    const statDiv = document.getElementById('statInfo');
    if (!data || data.length === 0) {
      statDiv.innerHTML = '';
      return;
    }
    // åªé‡å°ç›®å‰æŸ¥è©¢çµæœçš„å•†å“ï¼ˆå¦‚æœ‰å¤šç¨®å•†å“ï¼Œåƒ…é¡¯ç¤ºæŸ¥è©¢çµæœçš„å…¨éƒ¨ï¼‰
    // å…ˆä¾æ—¥æœŸæ’åº
    const arr = data.slice().sort((a, b) => a.date.localeCompare(b.date));
    // å–åƒ¹æ ¼æ•¸å­—
    const prices = arr.map(r => Number(r.product_price));
    // å–æ—¥æœŸ
    const dates = arr.map(r => r.date);

    // å–å¾—æœ¬æœˆ/ä»Šå¹´/è¿‘ä¸‰æœˆçš„è³‡æ–™
    const now = new Date();
    const thisYear = now.getFullYear();
    const thisMonth = now.getMonth() + 1;
    // è¿‘ä¸‰å€‹æœˆçš„èµ·å§‹
    const threeMonthAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
    // æœ¬æœˆ
    const arrThisMonth = arr.filter(r => {
      const d = new Date(r.date);
      return d.getFullYear() === thisYear && (d.getMonth() + 1) === thisMonth;
    });
    // ä»Šå¹´
    const arrThisYear = arr.filter(r => {
      const d = new Date(r.date);
      return d.getFullYear() === thisYear;
    });
    // è¿‘ä¸‰å€‹æœˆ
    const arr3m = arr.filter(r => {
      const d = new Date(r.date);
      return d >= threeMonthAgo && d <= now;
    });

    // æœ¬æœˆå¹³å‡
    let avgMonth = arrThisMonth.length ? (arrThisMonth.reduce((s, r) => s + Number(r.product_price), 0) / arrThisMonth.length).toFixed(2) : '-';
    // æœ¬æœˆæœ€ä½
    let minMonth = arrThisMonth.length ? Math.min(...arrThisMonth.map(r => Number(r.product_price))) : '-';
    // æœ¬æœˆæœ€é«˜
    let maxMonth = arrThisMonth.length ? Math.max(...arrThisMonth.map(r => Number(r.product_price))) : '-';
    // ä»Šå¹´æœ€é«˜
    let maxYear = arrThisYear.length ? Math.max(...arrThisYear.map(r => Number(r.product_price))) : '-';

    // è¿‘ä¸‰å€‹æœˆæ¼²å¹…ï¼ˆ%ï¼‰ï¼šä¸‰å€‹æœˆå‰çš„ç¬¬ä¸€ç­†èˆ‡æœ€æ–°ä¸€ç­†
    let change3m = '-';
    if (arr3m.length >= 2) {
      // ä¾æ—¥æœŸæ’åº
      arr3m.sort((a, b) => a.date.localeCompare(b.date));
      const first = Number(arr3m[0].product_price);
      const last = Number(arr3m[arr3m.length - 1].product_price);
      if (first !== 0) {
        change3m = (((last - first) / first) * 100).toFixed(1) + '%';
      } else {
        change3m = '-';
      }
    }

    // æœ¬æœˆæ¼²è·Œå¹…ï¼ˆ%ï¼‰ï¼šæœ¬æœˆç¬¬ä¸€ç­†èˆ‡æœ€å¾Œä¸€ç­†
    let changeMonth = '-';
    if (arrThisMonth.length >= 2) {
      arrThisMonth.sort((a, b) => a.date.localeCompare(b.date));
      const first = Number(arrThisMonth[0].product_price);
      const last = Number(arrThisMonth[arrThisMonth.length - 1].product_price);
      if (first !== 0) {
        changeMonth = (((last - first) / first) * 100).toFixed(1) + '%';
      } else {
        changeMonth = '-';
      }
    }

    if (arrThisMonth.length === 0) {
      statDiv.innerHTML = `
        <span style="color:#888">æœ¬æœˆç„¡è³‡æ–™</span><br>
        <b>ä»Šå¹´æœ€é«˜ï¼š</b> <span style="color:#d62828">${maxYear}</span>ã€€
        <b>è¿‘ä¸‰å€‹æœˆæ¼²å¹…ï¼š</b> <span style="color:#f77f00">${change3m}</span>
      `;
      return;
    }

    statDiv.innerHTML = `
      <b>æœ¬æœˆå¹³å‡ï¼š</b> <span style="color:#007f00">${avgMonth}</span>ã€€
      <b>æœ¬æœˆæœ€ä½ï¼š</b> <span style="color:#007f00">${minMonth}</span>ã€€
      <b>æœ¬æœˆæœ€é«˜ï¼š</b> <span style="color:#d62828">${maxMonth}</span>ã€€
      <b>æœ¬æœˆæ¼²è·Œå¹…ï¼š</b> <span style="color:#f77f00">${changeMonth}</span><br>
      <b>ä»Šå¹´æœ€é«˜ï¼š</b> <span style="color:#d62828">${maxYear}</span>ã€€
      <b>è¿‘ä¸‰å€‹æœˆæ¼²å¹…ï¼š</b> <span style="color:#f77f00">${change3m}</span>
    `;
  }

  // åˆå§‹è¼‰å…¥å…¨éƒ¨è³‡æ–™
  fetchAll();

  // è¡¨å–®æäº¤ï¼ˆæ–°å¢è³‡æ–™ï¼‰
  document.getElementById('insertForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const date = document.getElementById('date').value;
    const product_name = document.getElementById('product_name').value;
    const product_price = document.getElementById('product_price').value;
    try {
      const res = await fetch('/api/insert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, product_name, product_price })
      });
      const text = await res.text();
      document.getElementById('resultMsg').textContent = text;
      await fetchAll();
    } catch (err) {
      document.getElementById('resultMsg').textContent = 'ç™¼ç”ŸéŒ¯èª¤';
    }
    // æ–°å¢æˆåŠŸå¾Œæ¸…ç©ºæ¬„ä½
    document.getElementById('date').value = '';
    document.getElementById('product_name').value = '';
    document.getElementById('product_price').value = '';
  });

  // æœå°‹åŠŸèƒ½
  document.getElementById('searchBtn').addEventListener('click', function () {
    const keyword = document.getElementById('searchInput').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (!keyword && !startDate && !endDate) {
      fetchAll();
    } else {
      searchPrice(keyword, startDate, endDate);
    }
  });

  document.getElementById('searchInput').addEventListener('input', function () {
    const keyword = this.value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (!keyword && !startDate && !endDate) {
      fetchAll();
    } else {
      searchPrice(keyword, startDate, endDate);
    }
  });

  document.getElementById('startDate').addEventListener('change', function () {
    const keyword = document.getElementById('searchInput').value.trim();
    const startDate = this.value;
    const endDate = document.getElementById('endDate').value;
    if (!keyword && !startDate && !endDate) {
      fetchAll();
    } else {
      searchPrice(keyword, startDate, endDate);
    }
  });

  document.getElementById('endDate').addEventListener('change', function () {
    const keyword = document.getElementById('searchInput').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = this.value;
    if (!keyword && !startDate && !endDate) {
      fetchAll();
    } else {
      searchPrice(keyword, startDate, endDate);
    }
  });

  // æ–°å¢ï¼šç›£è½åˆªé™¤æŒ‰éˆ•
  document.querySelector('#priceTable').addEventListener('click', async function(e) {
    if (e.target.classList.contains('delete-btn')) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return;
      const id = e.target.getAttribute('data-id');
      try {
        const res = await fetch(`/api/price/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
          fetchAll();
        } else {
          alert(result.error || 'åˆªé™¤å¤±æ•—');
        }
      } catch (err) {
        alert('åˆªé™¤å¤±æ•—');
      }
    }
  });

  // å•†å“å¿«æ·æŸ¥è©¢ï¼ˆåœ–ç‰‡ï¼‰
  document.querySelectorAll('.product-img').forEach(img => {
    img.addEventListener('click', function () {
      const name = this.getAttribute('data-name');
      document.getElementById('searchInput').value = name;
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      if (name === '') {
        fetchAll();
      } else {
        const fullName = `æ¨‚äº‹æ´‹èŠ‹ç‰‡ï¼ˆ${name}ï¼‰`;
        searchPrice(fullName, '', '');
      }
    });
  });



  // åŒ¯å‡ºCSV
  document.getElementById('exportBtn').addEventListener('click', async function () {
    // åŒ¯å‡ºç›®å‰æŸ¥è©¢çµæœï¼ˆè¡¨æ ¼è³‡æ–™ï¼‰
    const tbody = document.querySelector('#priceTable tbody');
    if (!tbody || tbody.children.length === 0 || tbody.textContent.includes('æŸ¥ç„¡è³‡æ–™')) {
      alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
      return;
    }
    // å–å¾—ç›®å‰è¡¨æ ¼è³‡æ–™
    let rows = [];
    for (let tr of tbody.children) {
      if (tr.children.length < 3) continue;
      const date = tr.children[0].textContent;
      const name = tr.children[1].textContent;
      const price = tr.children[2].textContent;
      rows.push([date, name, price]);
    }
    // ç”¢ç”ŸCSVå­—ä¸²
    let csv = 'æ—¥æœŸ,å•†å“åç¨±,å•†å“åƒ¹æ ¼\n';
    rows.forEach(r => {
      csv += r.map(x => `"${x.replace(/"/g, '""')}"`).join(',') + '\n';
    });
    // ä¸‹è¼‰
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'price_export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // åŒ¯å…¥CSV
  document.getElementById('importBtn').addEventListener('click', function () {
    document.getElementById('importFile').click();
  });
  document.getElementById('importFile').addEventListener('change', async function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const msg = document.getElementById('importMsg');
    msg.textContent = '';
    // è®€å–CSV
    const reader = new FileReader();
    reader.onload = async function (evt) {
      let text = evt.target.result;
      // è§£æCSV
      let lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) {
        msg.textContent = 'CSVå…§å®¹ä¸è¶³';
        return;
      }
      // æª¢æŸ¥æ¨™é¡Œ
      let header = lines[0].replace(/\s/g, '');
      if (!/^(æ—¥æœŸ|date),?(å•†å“åç¨±|product_name),?(å•†å“åƒ¹æ ¼|product_price)$/i.test(header)) {
        msg.textContent = 'CSVæ¨™é¡Œéœ€ç‚º: æ—¥æœŸ,å•†å“åç¨±,å•†å“åƒ¹æ ¼';
        return;
      }
      // è½‰æˆç‰©ä»¶é™£åˆ—
      let data = [];
      for (let i = 1; i < lines.length; i++) {
        let cols = lines[i].split(',');
        if (cols.length < 3) continue;
        // å»é™¤å¼•è™Ÿ
        let date = cols[0].replace(/^"|"$/g, '').trim();
        let name = cols[1].replace(/^"|"$/g, '').trim();
        let price = cols[2].replace(/^"|"$/g, '').trim();
        if (!date || !name || !price) continue;
        data.push({date, product_name: name, product_price: price});
      }
      if (data.length === 0) {
        msg.textContent = 'æ²’æœ‰æœ‰æ•ˆè³‡æ–™';
        return;
      }
      // å‚³é€åˆ°å¾Œç«¯
      try {
        const res = await fetch('/api/import', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({data})
        });
        const result = await res.json();
        if (result.success) {
          msg.style.color = '#007f00';
          msg.textContent = `åŒ¯å…¥æˆåŠŸï¼Œå…±æ–°å¢${result.count}ç­†`;
          fetchAll();
        } else {
          msg.style.color = '#d62828';
          msg.textContent = result.error || 'åŒ¯å…¥å¤±æ•—';
        }
      } catch (err) {
        msg.style.color = '#d62828';
        msg.textContent = 'åŒ¯å…¥å¤±æ•—';
      }
    };
    reader.readAsText(file, 'utf-8');
    // æ¸…ç©ºinput
    e.target.value = '';
  });

  // åˆå§‹è¼‰å…¥å…¨éƒ¨è³‡æ–™ï¼ˆç­‰ DOM è¼‰å…¥å¾Œå†åŸ·è¡Œï¼‰
  document.addEventListener('DOMContentLoaded', function () {
    fetchAll();
  });

  // è¨‚é–± email çš„äº‹ä»¶ç›£è½å™¨
  document.getElementById('subscribeBtn').addEventListener('click', async function () {
    const email = document.getElementById('subscribeEmail').value.trim();
    const msg = document.getElementById('subscribeMsg');
    msg.textContent = '';

    if (!email || !email.includes('@')) {
      msg.style.color = '#d62828';
      msg.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email';
      return;
    }

    try {
      const res = await fetch('/api/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const result = await res.json();
      if (result.success) {
        msg.style.color = '#007f00';
        msg.textContent = 'è¨‚é–±æˆåŠŸ';

        // âœ… æ¸…ç©º email è¼¸å…¥æ¬„ä½
        document.getElementById('subscribeEmail').value = '';
      } else {
        msg.style.color = '#d62828';
        msg.textContent = result.error || 'è¨‚é–±å¤±æ•—';
      }
    } catch (err) {
      msg.style.color = '#d62828';
      msg.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
    }
  });


</script>
</body>
</html>
